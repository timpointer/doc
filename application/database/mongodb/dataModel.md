# 数据建模

## 文档结构
在MongoDB应用设计数据模型时，关键决定是解决文档结构和数据之间的关系。MongoDB允许嵌入式文档。

### 被嵌方式
嵌入式文档通过将相关数据存入一个文档中来捕捉数据关系。
何时应该使用：
- 实体之间有包含关系。一对对关系
- 实体之间有一对多关系。这种关系中，子文档通常和父文档视为一个整体。
通常嵌入方式，提供了更好的读性能。只需要一次查询操作。单文档下原子操作也成为了可能。

### 关联方式
关联方式通过链接或引用的方式表达关系。
何时该使用：
- 当嵌入方式导致数据重复，并不能提供高效的读性能优势。
- 表达复杂的多对多关系
- 对大型树结构建模



不同的关联方式展现了不同的依赖关系，谁拥有谁的信息，谁就依赖了谁。

## 写原子操作
MongoDB针对一个文档提供了原子操作。

4.0版本以后提供多文档事务支持。

### 操作因子与数据模型
#### 大数量的集合
```
{ log: "dev", ts: ..., info: ... }
{ log: "debug", ts: ..., info: ...}
```

可以聚合在一个文档，也可以每个日志类型放一个文档。

####　集合包含大量的小文档
每个文档可能只有一两个属性，但数量巨大。这时你可以通过某种逻辑把文档聚合起来。称为"rolling-up"。
聚合以后意味着查询时是拿到一组文档和更少的查询次数。对索引也有好处。

然后如果你每次只是拿一组数据里面其中一两条，这么做就划算了。另外如果小文档就是数据的天然模型的话，也不建议聚合它。

#### 为小文档优化存储
每个文档都有一些额外信息。但如果文档本身很小，这种额外信息就会变成负担。
有两个建议：
- 使用自定义ID,默认ID比较长，但要确保ID唯一
- 用更短的字段名，但这样会降低可读性，不推荐这么做。

